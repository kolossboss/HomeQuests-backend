name: Auto Create PR for codex/*

on:
  push:
    branches:
      - "codex/**"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Create PR if missing
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "main";
            const branch = context.ref.replace("refs/heads/", "");

            if (!branch.startsWith("codex/")) {
              core.info(`Skip: branch ${branch}`);
              return;
            }

            const headRef = `${owner}:${branch}`;
            const { data: openPrs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: headRef,
              base,
              per_page: 100
            });

            let pr = openPrs[0];
            if (openPrs.length > 0) {
              core.info(`PR existiert bereits: #${openPrs[0].number}`);
            }

            if (!pr) {
              const title = `Auto PR: ${branch}`;
              const body = [
                "Automatisch erstellt durch GitHub Actions.",
                "",
                `- Quelle: \`${branch}\``,
                `- Ziel: \`${base}\``
              ].join("\n");

              try {
                const created = await github.rest.pulls.create({
                  owner,
                  repo,
                  title,
                  head: branch,
                  base,
                  body,
                  maintainer_can_modify: true
                });
                pr = created.data;
                core.info(`PR erstellt: #${pr.number}`);
              } catch (error) {
                const message = String(error?.message || "");
                if (error?.status === 422 && message.includes("A pull request already exists")) {
                  core.info("PR existiert bereits (422), kein Fehler.");
                  return;
                }
                if (message.includes("not permitted to create or approve pull requests")) {
                  core.warning(
                    "GitHub Actions darf in diesem Repo keine PRs erstellen. " +
                    "Aktiviere in Settings -> Actions -> General: " +
                    "'Read and write permissions' und 'Allow GitHub Actions to create and approve pull requests'."
                  );
                  return;
                }
                throw error;
              }
            }

            // Auto-Merge aktivieren (squash), sobald PR-Checks gruen sind.
            try {
              await github.graphql(
                `
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(
                    input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }
                  ) {
                    pullRequest {
                      number
                    }
                  }
                }
                `,
                { pullRequestId: pr.node_id }
              );
              core.info(`Auto-Merge aktiviert fuer PR #${pr.number}`);
            } catch (error) {
              const message = String(error?.message || "");
              if (message.includes("Protected branch rules not configured for this branch")) {
                core.warning(
                  "Auto-Merge via GraphQL braucht Branch-Protection-Regeln. " +
                  "Fallback: versuche direkten Squash-Merge."
                );
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: pr.number,
                    merge_method: "squash"
                  });
                  core.info(`PR #${pr.number} direkt per Squash gemerged.`);
                  return;
                } catch (mergeError) {
                  const mergeMessage = String(mergeError?.message || "");
                  if (
                    mergeMessage.includes("Pull Request is not mergeable") ||
                    mergeMessage.includes("Required status check") ||
                    mergeMessage.includes("Review required") ||
                    mergeMessage.includes("Method Not Allowed")
                  ) {
                    core.warning(
                      "PR konnte nicht direkt gemerged werden (Checks/Reviews/Policies). " +
                      "PR bleibt offen und kann manuell gemerged werden."
                    );
                    return;
                  }
                  throw mergeError;
                }
              }
              if (
                message.includes("Resource not accessible by integration") ||
                message.includes("Auto merge is not allowed") ||
                message.includes("not permitted to create or approve pull requests")
              ) {
                core.warning(
                  "Auto-Merge konnte nicht aktiviert werden. " +
                  "Pruefe Repo-Settings: Allow auto-merge + Actions darf PRs erstellen/approven."
                );
                return;
              }
              throw error;
            }
